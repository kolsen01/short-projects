<!DOCTYPE html>
<html>

	<head>
		<title> My Location </title>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>

		<script> 
			var lat = -99999;
			var long = -99999;
			var map;
			var myOptions = {
				zoom: 13,
				center: me, 
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			var marker;
			var infowindow = new google.maps.InfoWindow();	

			function init() {
				map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
				mylocation();
				renderMap();
			}

			function mylocation() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(function(position) {
						lat = position.coords.latitude;
						long = position.coords.longitude;						
						printLocation();
					});
				}
			}	

			function printLocation() {
				elem = document.getElementById("location");
				elem.innerHTML = "<p>" + lat + ", " + long + "</p>";
			}

			function renderMap()
			{			
				me = new google.maps.LatLng(lat, long);
				map.panTo(me);
				
				// Create a marker
				marker = new google.maps.Marker({
					position: me,
					title: "Here I Am!"
				});
				marker.setMap(map);
					
				// Open info window on click of marker
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.setContent(marker.title);
					infowindow.open(map, marker);
				});
			}
		</script>

		<script>
			function loadMessages() {

				var xhr = new XMLHttpRequest();					
				xhr.open("GET", "location.json", true);
				xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

				console.log("Hit me 1");

				xhr.onreadystatechange = function() {
					console.log("Hit me 2");
					
					if (xhr.readyState == 4 && xhr.status == 200) {

						rawData = xhr.responseText;
						messages = JSON.parse(rawData);
						output = "<ul>";
						for (count = 0; count < messages.length; count++) {
							output += "<li>" + messages[count].content + " => " + messages[count].username + "</li>";
						}
						output += "</ul>";
						document.getElementById("messages").innerHTML = output;
					}

					else if (xhr.readyState ==4 && xhr.status !=200) {
						document.getElementById("messages").innerHTML = "<p> Nope </p>";
					}
				}
				console.log("Hit me 3");

				xhr.send("location.json");
				console.log("Hit me 4");
			}	

		</script>

	</head>	
	
	<body onload="init()">
		<h1> My Location </h1>
		<div id="location">Trying to determine location...</div>	
		<div id='map_canvas'> click </div>
	</body>

	<body onload="loadMessages()">
		<h1>Messages</h1>
		<div id="messages">Loading...</div>	
	</body>	

</html>