<!DOCTYPE html>
<html>

	<head>
		<title> My Location </title>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="style.css" />

		<script src="https://maps.google.com/maps/api/js?sensor=true"></script>
		<script src="http://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=false"> </script> 

		<script> 
			var lat = 0;
			var long = 0;
			var loc_lat = 0;
			var loc_long = 0;
			var	me = new google.maps.LatLng(lat, long);
			var pointPos = new google.maps.LatLng(loc_lat, loc_long);
			var map;
			var points = []; // list to hold array of people
			var points_land = []; //list to hold array of landmarks

			var parameters; // login +latlng
			var loc;
			var url = 'https://defense-in-derpth.herokuapp.com/sendLocation' //creating var for url
			var imageMe=  "me.png"
			var imagePeople = "people.png"
			var imageLandmark = "landmark.png"
			var d = 0; // distance for calculateDistance
			var dist_between = 0; //distance closest to me for landmarks
			var dist_between_miles = 0;
			var min = 0; 

			//Post request
			var xhr = new XMLHttpRequest();					
			xhr.open("POST", url, true);
			xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

			var infowindow = new google.maps.InfoWindow();	

			//gets my location
			function mylocation() {
				if (navigator.geolocation) {	
					navigator.geolocation.getCurrentPosition(function(position) {
						lat = position.coords.latitude;
						long = position.coords.longitude;

						parameters = "login=yH2jVivG&lat=" + lat + "&lng="	+ long;
						xhr.send(parameters);
						xhr.onreadystatechange = function() {
							if (xhr.readyState == 4 && xhr.status == 200) {
								loc = JSON.parse(xhr.responseText);
								createMap(loc);
							}			
						}
					});
				}
			}			

			//creates map
			function createMap(loc) {
				me = new google.maps.LatLng(lat, long);

				map = new google.maps.Map(document.getElementById('map_canvas'), {
					center: me,
					zoom: 13,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				});

				map.panTo(me);

				// filter through .people to get location of people
				for (count=0; count < loc['people'].length; count++) {
					pointPos = new google.maps.LatLng(loc['people'][count]['lat'], loc['people'][count]['lng']);

					var lat2=pointPos.lat();
					var long2=pointPos.lng();

					calculateDistance(lat, long, lat2, long2);	

					var point = new google.maps.Marker({ //marker
						position: pointPos,
						//title: loc['people'][count]['login'],
						info: "Login: " + loc['people'][count]['login'] + "<br>" + "Distance: " + d + " miles",
						"icon": imagePeople
					});	

					points.push(point);

					if (loc['people'][count]['login'] == "yH2jVivG") {
						continue;
					}

					else if (loc['people'][count-1]['login'] == loc['people'][count]['login']){
						continue;
					}

					points[count].setMap(map);		
							
					google.maps.event.addListener(points[count], 'mouseup', function() {
						infowindow.setContent(this.info);
						infowindow.open(map, this);
					});

					google.maps.event.addListener(points[count], 'mousedown', function() {
						infowindow.close();
					});	
				}	

				// filter through .location to get location of landmarks
				for (count=0; count < loc['landmarks'].length; count++) {
						var landmark_pos = new google.maps.LatLng(loc['landmarks'][count]['geometry']['coordinates'][1], loc['landmarks'][count]['geometry']['coordinates'][0]);	
						dist_between = google.maps.geometry.spherical.computeDistanceBetween(me, landmark_pos);
						dist_between_miles = dist_between *	0.000621371;

					points_land.push({"name":loc['landmarks'][count]['properties']['Location_Name'], "distance": dist_between_miles});	

					var point_land = new google.maps.Marker({ //marker
						position: landmark_pos,
						info: "Landmark: " + loc['landmarks'][count]['properties']['Details'],
						"icon": imageLandmark
					});	
					point_land.setMap(map);	

					//point_land.setMap(map);										
							
					google.maps.event.addListener(point_land, 'mouseup', function() {
						infowindow.setContent(this.info);
						infowindow.open(map, this);
					});

					google.maps.event.addListener(point_land, 'mousedown', function() {
						infowindow.close();
					});						
				//compareDist(points_land);
				}
				compareDist(points_land);
				console.log(min)
				var marker = new google.maps.Marker({ //marker
					position: me,
					info: "Me!" + "<br>" + "Closest Landmark: " + min.name + "<br>" + "Distance Away: " + min.distance + " miles",
					"icon": imageMe
				});

				marker.setMap(map);

				google.maps.event.addListener(marker, 'mouseup', function() {
					infowindow.setContent(this.info);
					infowindow.open(map, this);
				});

				google.maps.event.addListener(marker, 'mousedown', function() {
					infowindow.close();
				});		
									
			}

			//convert to radians
			//credit to moveable type scripts and stackexchange: Using the Haversine Formula in Javascript
			Number.prototype.toRadians = function() {
				return this * Math.PI / 180;
			}

			//calculates distance to nearby landmarks and people
			function calculateDistance(lat, long, lat2, long2) { //passes in my 'lat' and my 'long'

				//using Haversine formula found on movable type scripts	and stackexchange:Using the Haversine Formula in Javascript

				var R = 6371e3; // radius in meters
				var φ1 = lat.toRadians();
				var φ2 = lat2.toRadians();
				var Δφ = (lat2-lat).toRadians();
				var Δλ = (long2-long).toRadians();

				var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
				        Math.cos(φ1) * Math.cos(φ2) *
				        Math.sin(Δλ/2) * Math.sin(Δλ/2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

				var d_meters = R * c;
				d = d_meters * 0.000621371; //convert to miles

				return d;
			}

			//init, calls mylocation()
			function init() {
				var body = document.getElementById('map_canvas');
				body.innerHTML = "<h3> Loading ... </h3>";
				mylocation();
			}

			function compareDist(arr) {
				min = arr[0];
				for (k=0; k<arr.length; k++){
					if (arr[k].distance < min.distance) {
						min = arr[k].distance;
					}
				return min;	
				}
			}


	</script>

	</head>	
	
	<body onload="init()">
		<div id='map_canvas'> Trying to determine location... </div>
	</body>

</html>